<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fight Imperial</title>
<style>
body{margin:0;font-family:sans-serif;background:#222;color:white;text-align:center;}
canvas{display:block;margin:auto;background:#3a7;}
#ui{margin:20px;}
button{margin:5px;padding:10px 20px;font-size:16px;cursor:pointer;}
#deck{margin-top:10px;}
.cardSlot{
  display:inline-block;
  width:100px;
  height:50px;
  border:1px solid white;
  margin:2px;
  text-align:center;
  cursor:pointer;
  vertical-align:top;
  padding:2px;
  box-sizing:border-box;
}
.cardSlot.selected{border-color:gold;}
.cardSlot span{
  display:block;
  font-size:12px;
  line-height:14px;
  white-space:normal;
  word-wrap:break-word;
}
</style>
</head>
<body>
<div id="ui"></div>
<canvas id="c" width="420" height="600"></canvas>
<div id="deck"></div>
<script>
const canvas=document.getElementById("c"),ctx=canvas.getContext("2d");
let elixir=10,maxElixir=10,last=0;
let playerUnits=[],enemyUnits=[];
let gold=0,gameState="menu";
let chestResultText="";
let collection=[],deck=[],selectedCard=null;

// CARD DEFINITIONS
const allCards=[
  {name:"Sworder",tier:"common",cost:3,hp:120,dmg:20,type:"melee"},
  {name:"Dwarf Dudes",tier:"common",cost:1,hp:50,dmg:5,type:"melee",count:3},
  {name:"Bowperson",tier:"common",cost:3,hp:80,dmg:15,type:"ranged"},
  {name:"Burn Spirit",tier:"common",cost:2,hp:60,dmg:25,type:"spell"},
  {name:"Pirahna",tier:"rare",cost:4,hp:70,dmg:5,type:"water",aoe:true,lifetime:10000,immortal:true},
  {name:"Canoneer",tier:"rare",cost:3,hp:100,dmg:30,type:"ranged"},
  {name:"Collosus",tier:"rare",cost:5,hp:400,dmg:40,type:"tank"},
  {name:"Pig Mounted",tier:"rare",cost:4,hp:150,dmg:35,type:"melee"},
  {name:"Lavasphere",tier:"rare",cost:4,hp:0,dmg:50,type:"spell"},
  {name:"Luchador",tier:"rare",cost:4,hp:120,dmg:25,type:"melee",ability:{cost:2,action:"jumpAttack"}},
  {name:"Magnet",tier:"epic",cost:4,hp:0,dmg:0,type:"spell",ability:{action:"pull",duration:5000}},
  {name:"Dwarf Army",tier:"epic",cost:4,hp:50,dmg:5,type:"melee",count:6},
  {name:"Sorcerer",tier:"epic",cost:5,hp:100,dmg:15,type:"summon",summon:"Dwarf Army"},
  {name:"Tank",tier:"epic",cost:6,hp:300,dmg:20,type:"fastBullet"},
  {name:"Firebird",tier:"legendary",cost:6,hp:200,dmg:40,type:"fly"},
  {name:"Electroly",tier:"legendary",cost:6,hp:250,dmg:70,type:"ranged"},
  {name:"Disembodied Head",tier:"legendary",cost:5,hp:50,dmg:90,type:"rush"},
  {name:"Fart God",tier:"legendary",cost:7,hp:400,dmg:40,type:"melee",ability:{cost:2,action:"fart"}},
  {name:"Elephant",tier:"legendary",cost:10,hp:1000,dmg:80,type:"tank",slow:true,aoe:true,elixirMod:0.9}
];

// INITIAL COLLECTION â€” all common cards unlocked
collection = allCards.filter(c => c.tier === "common");

// MAIN MENU
const ui=document.getElementById("ui");
const deckDiv=document.getElementById("deck");
function showMenu(){
  gameState="menu";
  deckDiv.style.display="none";
  ui.innerHTML=`
    <h1>Fight Imperial</h1>
    <p>Gold: ${gold}</p>
    <button onclick="showDeck()">Choose Deck</button>
    <button onclick="showShop()">Shop</button>
    ${chestResultText?'<p>'+chestResultText+'</p>':''}
  `;
}
showMenu();

// DECK SELECTION
function showDeck() {
    gameState = "deck";
    deckDiv.style.display = "block";
    ui.innerHTML = `
        <h2>Select cards for your deck (1 or more)</h2>
        <button id="startBattleBtn" ${deck.length === 0 ? 'disabled' : ''}>Start Battle</button>
        <button onclick="showMenu()">Back</button>
    `;
    updateDeckUI();

    document.getElementById("startBattleBtn").onclick = startBattle;
}

function updateDeckUI() {
    deckDiv.innerHTML = '';
    collection.forEach(c => {
        let slot = document.createElement("div");
        slot.className = "cardSlot";

        let text = document.createElement("span");
        text.innerText = c.name;
        slot.appendChild(text);

        if(deck.includes(c)) slot.classList.add("selected");

        slot.addEventListener("click", () => {
            if(deck.includes(c)) deck = deck.filter(x => x !== c);
            else deck.push(c);
            updateDeckUI();
            showDeck(); // refresh Start button
        });

        deckDiv.appendChild(slot);
    });

    let deckNames = document.createElement("p");
    deckNames.innerText = "Deck: " + (deck.length > 0 ? deck.map(c => c.name).join(', ') : "(none selected)");
    deckDiv.appendChild(deckNames);
}

// SHOP
function showShop(){
  gameState="shop";
  deckDiv.style.display="none";
  ui.innerHTML=`
    <h1>Shop</h1>
    <p>Gold: ${gold}</p>
    <button onclick="buyChest(500)">Basic Chest (500)</button>
    <button onclick="buyChest(2000)">Obsidian Chest (2000)</button>
    <button onclick="buyChest(5000)">God Chest (5000)</button>
    <button onclick="showMenu()">Back</button>
    ${chestResultText?'<p>'+chestResultText+'</p>':''}
  `;
}

// CHEST OPENING
function buyChest(cost){
  if(gold<cost){chestResultText="Not enough gold!"; showShop(); return;}
  gold-=cost;
  let r=Math.random(),newCard;
  if(cost==500){ if(r<0.05) newCard=getRandomByTier("legendary"); else if(r<0.2) newCard=getRandomByTier("epic"); else if(r<0.6) newCard=getRandomByTier("rare"); else newCard=getRandomByTier("common"); }
  else if(cost==2000){ if(r<0.15) newCard=getRandomByTier("legendary"); else if(r<0.4) newCard=getRandomByTier("epic"); else if(r<0.8) newCard=getRandomByTier("rare"); else newCard=getRandomByTier("common"); }
  else{ if(r<0.3) newCard=getRandomByTier("legendary"); else if(r<0.7) newCard=getRandomByTier("epic"); else if(r<0.95) newCard=getRandomByTier("rare"); else newCard=getRandomByTier("common"); }
  if(!collection.includes(newCard)) collection.push(newCard);
  chestResultText="You got: "+newCard.name+" ("+newCard.tier+")";
  showShop();
}
function getRandomByTier(tier){return allCards.filter(c=>c.tier===tier)[Math.floor(Math.random()*allCards.filter(c=>c.tier===tier).length)];}

// START BATTLE
function startBattle(){
  if(deck.length===0){alert("Select at least 1 card!"); return;}
  gameState="play";
  ui.innerHTML='';
  deckDiv.style.display="none";
  playerUnits=[]; enemyUnits=[];
  elixir=maxElixir=10;
}

// ARENA CONSTANTS
const bridgeY=250;
const bridgeHeight=40; 
const waterY=bridgeY;
const waterHeight=40;

// DEPLOY UNIT
canvas.onclick=e=>{
  if(gameState!=="play") return;
  if(deck.length===0) return;
  let lane=e.offsetX<210?0:1;
  if(!selectedCard) selectedCard = deck[0];
  let card=selectedCard;
  if(card.name==="Pirahna" && (e.offsetY<waterY || e.offsetY>waterY+waterHeight)) return;
  if(card.name!=="Pirahna" && e.offsetY>=waterY && e.offsetY<=waterY+waterHeight) return;
  deployCard(card,lane,e.offsetY);
};
function deployCard(card,lane,y){
  if(elixir<card.cost) return;
  elixir-=card.cost;
  if(card.count){ for(let i=0;i<card.count;i++) playerUnits.push({...card,x:lane*210+90+i*15,y:y,spawnTime:performance.now()}); }
  else{ let u={...card,x:lane*210+90,y:y,spawnTime:performance.now()}; if(u.name==="Pirahna") u.immortal=true; if(u.name==="Magnet") u.duration=5000; playerUnits.push(u); }
}

// ENEMY SPAWN
function spawnEnemy(){ if(gameState!=="play") return; let e={hp:150,dmg:20,spd:0.8,x:Math.random()<0.5?90:300,y:50}; enemyUnits.push(e); }
setInterval(spawnEnemy,3000);

// UPDATE LOOP
function update(dt){
  if(gameState!=="play") return;
  elixir=Math.min(maxElixir,elixir+dt*0.001);
  let now=performance.now();

  playerUnits.forEach(u=>{
    if(u.lifetime && now-u.spawnTime>=u.lifetime) u.hp=0;
    if(u.duration && now-u.spawnTime>=u.duration) u.hp=0;
    if(u.type==="melee"||u.type==="tank"||u.type==="rush") u.y-=u.slow?0.3:0.8;
    if(u.type==="fly") u.y-=1.5;

    if(u.ability){
      if(u.ability.action==="jumpAttack") enemyUnits.forEach(en=>{if(Math.abs(en.x-u.x)<50&&Math.abs(en.y-u.y)<50) en.hp-=u.dmg;});
      if(u.ability.action==="fart") enemyUnits.forEach(en=>{if(Math.abs(en.x-u.x)<50&&Math.abs(en.y-u.y)<50) en.x+=5;});
      if(u.ability.action==="pull") enemyUnits.forEach(en=>{let dx=u.x-en.x,dy=u.y-en.y,dist=Math.sqrt(dx*dx+dy*dy); if(dist<100){en.x+=dx*0.05; en.y+=dy*0.05;}});
    }

    if(u.aoe) enemyUnits.forEach(en=>{if(Math.abs(en.x-u.x)<30&&Math.abs(en.y-u.y)<30) en.hp-=u.dmg*0.5;});
  });

  enemyUnits.forEach(e=>{
    e.y+=e.spd;
    playerUnits.forEach(u=>{if(!u.immortal&&Math.abs(u.x-e.x)<25&&Math.abs(u.y-e.y)<25) u.hp-=e.dmg;});
  });

  playerUnits=playerUnits.filter(u=>u.hp>0&&u.y>0);
  enemyUnits=enemyUnits.filter(e=>e.hp>0&&e.y<600);

  if(enemyUnits.length===0 && playerUnits.length>0 && performance.now()>5000){gold+=100; alert("You Win! +100 Gold"); showMenu();}
  if(enemyUnits.some(e=>e.y>=600)){alert("You Lose! +0 Gold"); showMenu();}
}

// DRAW LOOP
function draw(){
  ctx.clearRect(0,0,420,600);
  if(gameState!=="play") return;

  // ARENA
  ctx.fillStyle="#2a5"; ctx.fillRect(0,0,420,600);
  ctx.fillStyle="#06f"; ctx.fillRect(0,waterY,420,waterHeight);
  ctx.fillStyle="#8b4513"; ctx.fillRect(50,bridgeY,100,bridgeHeight);
  ctx.fillRect(270,bridgeY,100,bridgeHeight);

  // UNITS
  playerUnits.forEach(u=>{
    ctx.fillStyle=u.tier==="legendary"?"gold":u.tier==="epic"?"purple":u.tier==="rare"?"blue":"green";
    ctx.fillRect(u.x-15,u.y-15,30,30);
    ctx.fillStyle="white";
    ctx.font="10px sans-serif";
    ctx.fillText(u.name,u.x-20,u.y-20);
  });
  enemyUnits.forEach(e=>{ctx.fillStyle="red";ctx.fillRect(e.x-15,e.y-15,30,30);});

  ctx.fillStyle="white"; ctx.font="14px sans-serif";
  ctx.fillText("Elixir: "+elixir.toFixed(1),10,20);
}

// MAIN LOOP
function loop(t){let dt=t-last; last=t; update(dt); draw(); requestAnimationFrame(loop);}
loop(0);
</script>
</body>
</html>


